<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Buffer Guess Who</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>

  <body>
    <script type="text/javascript">
      console.log('Top of the page');
    </script>
    <h1>Buffer Guess Who!</h1>
    <p>Lost track of all the people at Buffer and their <abbr title="wives and girlfriends">WAGs</abbr> and <abbr title="husbands and boyfriends">HABs</abbr>?  Play this game to learn their names!</p>
    <form action="" method="GET" autocomplete="off" name="buffer-guess-who">
      <img id="image" height="200px" alt="Buffer (WAG/HAB)">
      <fieldset id="guesswho">
        <legend>Who is this?</legend>
        <input type="radio" id="choice1" name="name" value="">
        <label for="choice1" id="choice1text"></label>
        <br>
        <input type="radio" id="choice2" name="name" value="">
        <label for="choice2" id="choice2text"></label>
        <br>
        <input type="radio" id="choice3" name="name" value="">
        <label for="choice3" id="choice3text"></label>
      </fieldset>
      <input id="submit" type="submit" value="Submit"?
    </form>
    <p id="notice"></p>
    <script type="text/javascript">
      console.log('Showing image and options.');
    </script>
    <p id="play-again"><a href='#'>Play again!</a></p>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script type="text/javascript">

      var data = {
        // Need at least three images to prevent an infinite loop because three options are given.
/*        'caity_colin.jpg'     : 'Caity and Colin',
        'nicole_john.jpg'     : 'Nicole and John (aka Rusty)',
        'mike_maria.jpg'      : 'Mike and Maria',
        'sunil_avanti.jpg'    : 'Sunil and Avanti',
        'danieka_michael.jpg' : 'Danieka and Michael',
        'amber_adam.jpg'      : 'Amber and Adam',
        'caity.jpg'           : 'Caity',
        'colin.jpg'           : 'Colin',
        'nicole.jpg'          : 'Nicole',
        'john.jpg'            : 'John (aka Rusty)',
        'mike.jpg'            : 'Mike',
        'maria.jpg'           : 'Maria',
        'sunil.jpg'           : 'Sunil',
        'avanti.jpg'          : 'Avanti',
        'danieka.jpg'         : 'Danieka',*/
        'michael.jpg'         : 'Michael',
        'amber.jpg'           : 'Amber',
        'adam.jpg'            : 'Adam'
      };
      var images = _.keys(data);
      var answer_index;
      var seen = {};
      var num_seen = 0;
      console.log('Initialised');

      $(function(){

        function reset(){
          $('#guesswho').show();
          $('#submit').show();
          $('#play-again').hide();
          var selected = $("input[type='radio'][name='name']:checked").prop('checked', false);

          if ( images.length > 2 ) {
            while (true) {
              answer_index = Math.floor ( images.length * Math.random() );
              if ( !seen[answer_index] ) { 
                break;
              }
            }
            seen[answer_index] = true;
            ++num_seen;
            console.log( 'answer index: ' + answer_index );
            console.log( 'seen: ' + seen );
            console.log( 'number seen: ' + num_seen );
            $('#image').attr('src', 'img/' + images[answer_index]);
            $('#notice').html('');
            $('#play-again').hide();

            var choices = {};
            choices[answer_index] = true;

            while (true) {
              var index = Math.floor ( images.length * Math.random() );
              if ( !choices[index] ) { 
                break;
              }
            }
            choices[index] = true;
            while (true) {
              var index = Math.floor ( images.length * Math.random() );
              if ( !choices[index] ) { 
                break;
              }
            }
            choices[index] = true;
            console.log(choices);
            var image_choices = _.map(_.keys(choices), function(c){
              return images[c];
            });
            console.log(image_choices);
            
            image_choices = _.shuffle(image_choices);

            $('#choice1').val(image_choices[0]);
            $('#choice1text').text(data[image_choices[0]]);

            $('#choice2').val(image_choices[1]);
            $('#choice2text').text(data[image_choices[1]]);

            $('#choice3').val(image_choices[2]);
            $('#choice3text').text(data[image_choices[2]]);
          } else {
            alert('Not enough images.  At least three images are required.');
            console.log('Make sure there are at least three images given in \'data\'.  Image data: ' + images);
            return false;
          }
        };

        $('#play-again').click(function(e){
          e.preventDefault();
          reset();
          return false;
        });

        $('#submit').click(function(){
          var selected = $("input[type='radio'][name='name']:checked").val();
          console.log(selected);
          if ( selected == images[answer_index] ) {
            console.log('Right!');
            if (num_seen == images.length) {
              console.log('That\'s all folks!');
              $('#notice').html('You got them all right.  Well done!');
              $('#play-again').hide();
              $('#guesswho').hide();
              $('#submit').hide();
              return;
            } else {
              $('#notice').html('Yay, that is ' + data[selected] + ' &mdash; well done!');
              $('#play-again').show();
              $('#guesswho').hide();
              $('#submit').hide();
            }
          } else {
            console.log('Wrong!');
            $('#notice').html('Oh noes, that\'s not ' + data[selected] + '!  Try again.');
          }
        });

        reset();

      });
    </script>
  </body>

</html>
