<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Buffer Guess Who</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>

  <body>
    <h1>Buffer Guess Who!</h1>
    <p>Lost track of all the people at <a href="https://buffer.com/" title="Buffer">Buffer</a> and their <abbr title="wives and girlfriends">WAGs</abbr> and <abbr title="husbands and boyfriends">HABs</abbr>?  Play this game to learn their names!</p>
    <form method="GET" autocomplete="off" name="buffer-guess-who">
      <figure>
        <img id="image" height="200" alt="Buffer (WAG/HAB)">
        <figcaption id="counter"></figcaption>
      </figure>
      <fieldset id="guesswho">
        <legend>Who is this?</legend>
        <input type="radio" id="choice1" name="name" value="">
        <label for="choice1" id="choice1text"></label>
        <br>
        <input type="radio" id="choice2" name="name" value="">
        <label for="choice2" id="choice2text"></label>
        <br>
        <input type="radio" id="choice3" name="name" value="">
        <label for="choice3" id="choice3text"></label>
      </fieldset>
      <input id="submit" type="submit" value="Submit"?
    </form>
    <p id="notice"></p>
    <p id="score"></p>
    <button id="play-next"><a href='#'>Bring on the next one!</a></button>
    <button id="start-again"><a href=''>Play again?</a></button>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script type="text/javascript">

      var data = {
        // Need at least three images to prevent an infinite loop because three options are given.
        // Only use underscores in file names to separate multiple people.
        /*'caity_colin.jpg'     : 'Caity and Colin',*/
        'nicole_john.jpg'     : 'Nicole and John (aka Rusty)',
//        'mike_maria-640x640.jpg'  : 'Mike and Maria',// square images are broken
        'mike_maria-518x572.jpg'  : 'Mike and Maria',
        'sunil_avanti.jpg'    : 'Sunil and Avanti',
        'danieka_michael.jpg' : 'Danieka and Michael',
        'amber_adam.jpg'      : 'Amber and Adam',
        'caity.jpg'           : 'Caity',
        'colin.jpg'           : 'Colin',
        'nicole.jpg'          : 'Nicole',
        'john.jpg'            : 'John (aka Rusty)',
        'mike.jpg'            : 'Mike',
        'maria.jpg'           : 'Maria',
        'sunil.jpg'           : 'Sunil',
        'avanti.jpg'          : 'Avanti',
        'danieka.jpg'         : 'Danieka',
        'michael.jpg'         : 'Michael',
        'amber.jpg'           : 'Amber',
        'adam.jpg'            : 'Adam'*/
      };
      var images = _.keys(data);
      var answer_index;
      var seen = {};
      var num_seen = 0;
      console.log('Initialised');
      var num_guesses = 0;
      var num_right_guesses = 0;
      var right_first_time;
      var num_images = images.length;

      $(function(){

        function reset(){
          $('#guesswho').show();
          $('#submit').show();
          $('#play-next').hide();
          $('#start-again').hide();
          $('#counter').show();
          var selected = $("input[type='radio'][name='name']:checked").prop('checked', false);
          right_first_time = true;

          if ( num_images > 2 ) {
            while (true) {
              answer_index = Math.floor ( num_images * Math.random() );
              if ( !seen[answer_index] ) { 
                break;
              }
            }
            seen[answer_index] = true;
            ++num_seen;
            $('#counter').html('Image ' + num_seen + ' of ' + num_images + '.');
            console.log( 'answer index: ' + answer_index );
            console.log( 'seen: ' + seen );
            console.log( 'number seen: ' + num_seen );
            $('#image').attr('src', 'img/' + images[answer_index]);
            $('#notice').html('');
            $('#play-next').hide();

            var choices = {};
            choices[answer_index] = true;
            console.log('Answer: ' + data[images[answer_index]] + ' — ' + images[answer_index]);

            while (true) {
              var index = Math.floor ( num_images * Math.random() );
              if ( !choices[index] ) { 
                if ( ( ( images[index].indexOf('_') != -1 ) && ( images[answer_index].indexOf('_') != -1 ) ) ||
                     ( ( images[index].indexOf('_') == -1 ) && ( images[answer_index].indexOf('_') == -1 ) ) ) {
                  console.log('Option 2: ' + data[images[index]] + ' — ' + images[index]);
                  console.log('index: ' + images[index].indexOf('_') + '; answer index: ' + images[answer_index].indexOf('_') );
                  break;
                }
              }
            }
            choices[index] = true;
            while (true) {
              var index = Math.floor ( num_images * Math.random() );
              if ( !choices[index] ) { 
                if ( ( ( images[index].indexOf('_') != -1 ) && ( images[answer_index].indexOf('_') != -1 ) ) ||
                     ( ( images[index].indexOf('_') == -1 ) && ( images[answer_index].indexOf('_') == -1 ) ) ) {
                  console.log('Option 3: ' + data[images[index]] + ' — ' + images[index]);
                  console.log('index: ' + images[index].indexOf('_') + '; answer index: ' + images[answer_index].indexOf('_') );
                  break;
                }
              }
            }
            choices[index] = true;
            console.log(choices);
            var image_choices = _.map(_.keys(choices), function(c){
              return images[c];
            });
            console.log(image_choices);
            
            image_choices = _.shuffle(image_choices);

            $('#choice1').val(image_choices[0]);
            $('#choice1text').text(data[image_choices[0]]);

            $('#choice2').val(image_choices[1]);
            $('#choice2text').text(data[image_choices[1]]);

            $('#choice3').val(image_choices[2]);
            $('#choice3text').text(data[image_choices[2]]);
          } else {
            alert('Not enough images.  At least three images are required.');
            console.log('Make sure there are at least three images given in \'data\'.  Image data: ' + images);
            return false;
          }
        };

        $('#play-next').click(function(e){
          e.preventDefault();
          reset();
          return false;
        });

        $('#submit').click(function(){
          var selected = $("input[type='radio'][name='name']:checked").val();
          console.log(selected);
          if ( selected == images[answer_index] ) {
            console.log('Right!');
            if (num_seen == images.length) {
              console.log('That\'s all folks!');
              if ( right_first_time ) {
                ++num_right_guesses;
              }
              $('#notice').html('Yay, this is ' + data[selected] + ' &mdash; well done!');
              $('#score').html('You scored ' + num_right_guesses + '/' + num_images + '!');
              $('#play-next').hide();
              $('#guesswho').hide();
              $('#submit').hide();
              $('#start-again').show();
              $('#counter').hide();
              return;
            } else {
              if ( right_first_time ) {
                ++num_right_guesses;
              }
              $('#notice').html('Yay, this is ' + data[selected] + ' &mdash; well done!');
              $('#play-next').show();
              $('#guesswho').hide();
              $('#submit').hide();
            }
          } else if ( selected ) {
            console.log('Wrong!');
            right_first_time = false;
            $('#notice').html('Oh noes, this is not ' + data[selected] + '!  Try again.');
          } else {
            $('#notice').html('Please pick an option!');
          }
        });

        reset();

      });
    </script>
  </body>

</html>
